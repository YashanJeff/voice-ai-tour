// Use free AI API with dynamic room detection
        async function getAIResponse(userMessage, foundRoom = null) {
            // Use predefined descriptions instead of API
            if (foundRoom) {
                const response = foundRoom.description || `✅ Successfully navigated to ${foundRoom.name}! You should now see the panorama. Look around the 360° view to explore this location.`;
                
                // Also speak the response
                const spokenText = foundRoom.spoken_description || `You are now in ${foundRoom.name}.`;
                setTimeout(() => {
                    speakText(spokenText);
                }, 1000);
                
                return response;
            } else {
                const availableRooms = CONFIG.TOUR_CONFIG.rooms.map(r => r.name).join(', ');
                const response = `🎯 I can help you navigate to: ${availableRooms}. Try saying "Take me to room 101" or "Show me room 105".`;
                
                // Speak the help message
                setTimeout(() => {
                    speakText("I can take you to room 101, 105, or 106. Which room would you like to visit?");
                }, 500);
                
                return response;
            }
        }

        // Capture and analyze current view with dynamic room data
        async function captureAndAnalyzeView(room) {
            try {
                // Use predefined description instead of AI analysis
                const description = room.description || `Welcome to ${room.name}! You're now viewing this location in 360 degrees.`;
                const spokenText = room.spoken_description || `You are now in ${room.name}.`;
                
                console.log('Showing description for:', room.name);
                
                // Show text description
                showAIResponse(description, room.name);
                
                // Speak the description
                setTimeout(() => {
                    speakText(spokenText);
                }, 500);
                
            } catch (error) {
                console.error('Error displaying description:', error);
                const fallbackResponse = `I've taken you to ${room.name}. This appears to be a 360-degree panoramic view of the location.`;
                showAIResponse(fallbackResponse, room.name);
                speakText(`You are now in ${room.name}.`);
            }
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI Navigator - 3DVista Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }

        #main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 3DVista Tour Container */
        #tour-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Voice AI Control Panel */
        #voice-control {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        #voice-control:hover {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }

        #voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #voice-btn:hover {
            transform: scale(1.1);
        }

        #voice-btn.listening {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            animation: pulse 2s infinite;
        }

        #voice-btn.processing {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: spin 1s linear infinite;
        }

        /* Add stop speaking button */
        #stop-speaking-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ffa726, #ff7043);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        #stop-speaking-btn:hover {
            transform: scale(1.1);
        }

        #stop-speaking-btn.visible {
            display: block;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 210, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #voice-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        #voice-text {
            font-size: 16px;
            font-weight: 500;
            min-width: 200px;
            text-align: center;
        }

        #voice-subtitle {
            font-size: 12px;
            opacity: 0.7;
            text-align: center;
        }

        /* AI Response Panel */
        #ai-response {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        #ai-response.visible {
            transform: translateX(0);
        }

        #ai-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #ai-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        #ai-message {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        #ai-vision {
            font-size: 12px;
            opacity: 0.8;
            font-style: italic;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
            margin-top: 10px;
        }

        #close-response {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        #close-response:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation Status */
        #nav-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 999;
            display: none;
            transition: all 0.3s ease;
        }

        .status-success {
            background: rgba(0, 255, 0, 0.8) !important;
        }

        .status-error {
            background: rgba(255, 0, 0, 0.8) !important;
        }

        .status-info {
            background: rgba(0, 150, 255, 0.8) !important;
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #voice-control {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
                width: calc(100% - 20px);
            }

            #ai-response {
                right: 10px;
                top: 10px;
                width: calc(100% - 20px);
                transform: translateY(-450px);
            }

            #ai-response.visible {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <!-- 3DVista Tour will be embedded here -->
        <div id="tour-container">
            <!-- Replace this with your 3DVista embed code -->
            <iframe id="tour-frame" src="./index.html" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
        </div>

        <!-- Voice Control Panel -->
        <div id="voice-control">
            <button id="voice-btn">🎤</button>
            <button id="stop-speaking-btn" onclick="stopSpeaking()">🔇</button>
            <div id="voice-status">
                <div id="voice-text">Click to speak</div>
                <div id="voice-subtitle">Say "Take me to..." or "Show me..."</div>
            </div>
        </div>

        <!-- AI Response Panel -->
        <div id="ai-response">
            <div id="ai-header">
                <h3>🤖 AI Vision</h3>
                <button id="close-response" onclick="hideAIResponse()">×</button>
            </div>
            <div id="ai-content">
                <div id="ai-message"></div>
                <div id="ai-vision"></div>
            </div>
        </div>

        <!-- Navigation Status -->
        <div id="nav-status">Ready</div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Replace with your actual API keys
            OPENAI_API_KEY: 'YOUR_OPENAI_API_KEY_HERE',
            HUGGINGFACE_API_KEY: 'YOUR_HUGGINGFACE_API_KEY_HERE',
            
            // 3DVista Tour Configuration - Dynamic Detection
            TOUR_CONFIG: {
                // Define room keywords that will dynamically find panoramas
                rooms: [
                    {
                        id: 'room_101',
                        name: 'Room 101',
                        keywords: ['room 101', 'flat 101', 'apartment 101', 'unit 101', 'one zero one', '101', 'one oh one'],
                        room_number: '101',
                        description: 'Welcome to Room 101! This is a beautiful 1RK apartment with modern amenities. We have multiple customization options available including various wall textures, flooring options, and premium wood finishes.',
                        spoken_description: 'Welcome to room 101. This room is 1RK and we have multiple options for wall, floor, and wood textures.'
                    },
                    {
                        id: 'room_105',
                        name: 'Room 105',
                        keywords: ['room 105', 'flat 105', 'apartment 105', 'unit 105', 'one zero five', '105', 'one oh five'],
                        room_number: '105',
                        description: 'Welcome to Room 105! This elegant apartment features high-quality construction and modern amenities. Discover the various customization possibilities for your perfect living space.',
                        spoken_description: 'This is room 105, featuring elegant design with high-quality construction and various customization possibilities.'
                    },
                    {
                        id: 'room_106',
                        name: 'Room 106',
                        keywords: ['room 106', 'flat 106', 'apartment 106', 'unit 106', 'one zero six', '106', 'one oh six'],
                        room_number: '106',
                        description: 'Welcome to Room 106! This spacious unit offers contemporary design with flexible layout options. Explore the premium materials and finishes available for your dream home.',
                        spoken_description: 'You are now in room 106. This is a spacious unit with contemporary design and premium material options.'
                    }
                ],
                // This will be populated dynamically by scanning the tour
                detected_panoramas: [],
                detected_hotspots: []
            }
        };

        // Global variables
        let isListening = false;
        let isProcessing = false;
        let recognition = null;
        let currentPanorama = null;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            console.log('Initializing speech recognition...');
            
            if ('webkitSpeechRecognition' in window) {
                console.log('Using webkitSpeechRecognition');
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                console.log('Using SpeechRecognition');
                recognition = new SpeechRecognition();
            } else {
                console.error('Speech recognition not supported');
                showStatus('Speech recognition not supported in this browser. Please use Chrome or Edge.', 'error');
                return false;
            }

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                console.log('Speech recognition started');
                isListening = true;
                updateVoiceButton();
                updateVoiceStatus('Listening...', 'Speak your command');
                showStatus('Listening for your voice...', 'info');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Voice input received:', transcript);
                updateVoiceStatus('Processing...', transcript);
                showStatus('Voice received: ' + transcript, 'success');
                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMessage = 'Voice recognition error: ' + event.error;
                
                if (event.error === 'not-allowed') {
                    errorMessage = 'Microphone access denied. Please allow microphone access and try again.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'No speech detected. Please try again and speak clearly.';
                } else if (event.error === 'network') {
                    errorMessage = 'Network error. Please check your internet connection.';
                }
                
                showStatus(errorMessage, 'error');
                resetVoiceButton();
            };

            recognition.onend = function() {
                console.log('Speech recognition ended');
                isListening = false;
                if (!isProcessing) {
                    resetVoiceButton();
                }
            };

            console.log('Speech recognition initialized successfully');
            return true;
        }

        // Toggle voice recognition
        function toggleVoiceRecognition() {
            console.log('Voice button clicked. isListening:', isListening, 'isProcessing:', isProcessing);
            
            if (isListening || isProcessing) {
                console.log('Stopping voice recognition');
                stopVoiceRecognition();
            } else {
                console.log('Starting voice recognition');
                startVoiceRecognition();
            }
        }

        // Start voice recognition
        function startVoiceRecognition() {
            console.log('startVoiceRecognition called');
            
            if (!recognition) {
                console.log('Recognition not initialized, initializing now...');
                if (!initSpeechRecognition()) {
                    console.error('Failed to initialize speech recognition');
                    return;
                }
            }

            try {
                console.log('Attempting to start recognition...');
                recognition.start();
                showStatus('Starting voice recognition...', 'info');
            } catch (error) {
                console.error('Failed to start recognition:', error);
                showStatus('Failed to start voice recognition: ' + error.message, 'error');
            }
        }

        // Stop voice recognition
        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
            }
            resetVoiceButton();
        }

        // Update voice button state
        function updateVoiceButton() {
            const btn = document.getElementById('voice-btn');
            if (isListening) {
                btn.classList.add('listening');
                btn.classList.remove('processing');
                btn.innerHTML = '🎙️';
            } else if (isProcessing) {
                btn.classList.add('processing');
                btn.classList.remove('listening');
                btn.innerHTML = '🤖';
            } else {
                btn.classList.remove('listening', 'processing');
                btn.innerHTML = '🎤';
            }
        }

        // Reset voice button
        function resetVoiceButton() {
            isListening = false;
            isProcessing = false;
            updateVoiceButton();
            updateVoiceStatus('Click to speak', 'Say "Take me to..." or "Show me..."');
        }

        // Update voice status text
        function updateVoiceStatus(main, sub) {
            document.getElementById('voice-text').textContent = main;
            document.getElementById('voice-subtitle').textContent = sub;
        }

        // Process voice command with dynamic room detection
        async function processVoiceCommand(transcript) {
            isProcessing = true;
            updateVoiceButton();

            try {
                console.log('Processing voice command:', transcript);
                
                // Find matching room using dynamic detection
                const matchedRoom = findMatchingRoom(transcript);
                
                if (matchedRoom) {
                    console.log('Found matching room:', matchedRoom.name, 'Number:', matchedRoom.room_number);
                    
                    // Navigate to room
                    const navigationSuccess = await navigateToVistaPanorama(matchedRoom);
                    
                    if (navigationSuccess) {
                        console.log('✅ Navigation successful for:', matchedRoom.name);
                    } else {
                        showAIResponse(`Sorry, I couldn't navigate to ${matchedRoom.name}. There might be a technical issue.`, 'Navigation Error');
                    }
                } else {
                    console.log('No matching room found for:', transcript);
                    // Use general AI response for unrecognized commands
                    const aiResponse = await getAIResponse(transcript);
                    showAIResponse(aiResponse, 'AI Assistant');
                }
                
            } catch (error) {
                console.error('Error processing voice command:', error);
                showAIResponse("Sorry, I'm having trouble processing your request. Please try again.", 'Error');
                showStatus('Error processing command', 'error');
            } finally {
                resetVoiceButton();
            }
        }

        // Find matching panorama
        function findMatchingPanorama(transcript) {
            const input = transcript.toLowerCase();
            return CONFIG.TOUR_CONFIG.panoramas.find(pano => 
                pano.keywords.some(keyword => 
                    input.includes(keyword.toLowerCase())
                )
            );
        }

        // Navigate to room using dynamic detection
        async function navigateToVistaPanorama(room) {
            try {
                const iframe = document.querySelector('iframe');
                if (!iframe) {
                    throw new Error('Tour iframe not found');
                }

                console.log('🎯 Attempting navigation to:', room.name, 'Room number:', room.room_number);
                
                // Get detected panoramas and hotspots for this room
                const roomData = await scanTourStructure();
                const roomInfo = roomData ? roomData[room.room_number] : null;
                
                if (!roomInfo) {
                    console.log('❌ No room data found, using fallback detection');
                }
                
                // Method 1: Use detected hotspots and panoramas
                let navigationSuccess = false;
                
                if (roomInfo && roomInfo.hotspots.length > 0) {
                    console.log('🎯 Found detected hotspots for room', room.room_number, ':', roomInfo.hotspots);
                    
                    // Try each detected hotspot
                    for (const hotspot of roomInfo.hotspots) {
                        try {
                            console.log('🎯 Attempting to click hotspot:', hotspot.hotspot_name);
                            console.log('🎯 Element:', hotspot.element);
                            
                            // Try different click methods
                            if (hotspot.element && hotspot.element.click) {
                                hotspot.element.click();
                                console.log('✅ Successfully clicked hotspot:', hotspot.hotspot_name);
                                navigationSuccess = true;
                                break;
                            }
                            
                            // Try executing onclick directly
                            if (hotspot.onclick) {
                                console.log('🔧 Executing onclick:', hotspot.onclick);
                                iframe.contentWindow.eval(hotspot.onclick);
                                console.log('✅ Successfully executed onclick');
                                navigationSuccess = true;
                                break;
                            }
                            
                        } catch (error) {
                            console.log('❌ Failed to click hotspot:', hotspot.hotspot_name, error);
                            continue;
                        }
                    }
                }
                
                // Method 2: Fallback - search for any element related to this room
                if (!navigationSuccess) {
                    console.log('🔍 Fallback: Searching for any element containing room number:', room.room_number);
                    
                    try {
                        if (iframe.contentDocument) {
                            const allElements = iframe.contentDocument.querySelectorAll('*');
                            const roomElements = [];
                            
                            allElements.forEach((element) => {
                                const onclick = element.getAttribute('onclick') || '';
                                const id = element.getAttribute('id') || '';
                                const className = element.className || '';
                                const title = element.getAttribute('title') || '';
                                
                                // Check if element contains room number
                                const hasRoomNumber = 
                                    onclick.includes(room.room_number) ||
                                    id.includes(room.room_number) ||
                                    className.includes(room.room_number) ||
                                    title.includes(room.room_number);
                                
                                if (hasRoomNumber && element.click) {
                                    roomElements.push({
                                        element,
                                        onclick,
                                        id,
                                        className,
                                        score: 0
                                    });
                                }
                            });
                            
                            // Score elements by relevance
                            roomElements.forEach(item => {
                                let score = 0;
                                if (item.onclick.includes('goto') || item.onclick.includes('GoTo')) score += 5;
                                if (item.onclick.includes('navigate')) score += 5;
                                if (item.id.includes('GoTo')) score += 3;
                                if (item.className.includes('hotspot')) score += 2;
                                if (item.onclick.includes(room.room_number + '-')) score += 3; // 101-1, 105-1
                                item.score = score;
                            });
                            
                            // Sort by score and try to click
                            roomElements.sort((a, b) => b.score - a.score);
                            
                            console.log('🔍 Found room elements:', roomElements.slice(0, 3));
                            
                            if (roomElements.length > 0) {
                                const bestElement = roomElements[0];
                                console.log('🎯 Trying best element:', bestElement);
                                
                                try {
                                    bestElement.element.click();
                                    console.log('✅ Successfully clicked fallback element');
                                    navigationSuccess = true;
                                } catch (error) {
                                    console.log('❌ Failed to click fallback element:', error);
                                }
                            }
                        }
                    } catch (error) {
                        console.log('❌ Fallback search failed:', error);
                    }
                }
                
                // Method 3: Try URL-based navigation with detected panorama names
                if (!navigationSuccess && roomInfo && roomInfo.panoramas.length > 0) {
                    console.log('🔗 Trying URL-based navigation with detected panoramas');
                    
                    for (const pano of roomInfo.panoramas) {
                        try {
                            const currentUrl = iframe.src;
                            const baseUrl = currentUrl.split('?')[0];
                            const newUrl = `${baseUrl}?startmedia=${pano.pano_name}`;
                            
                            console.log('🔗 Trying URL:', newUrl);
                            iframe.src = newUrl;
                            navigationSuccess = true;
                            break;
                        } catch (error) {
                            console.log('❌ URL navigation failed for:', pano.pano_name, error);
                            continue;
                        }
                    }
                }
                
                // Method 4: Try common panorama naming patterns
                if (!navigationSuccess) {
                    console.log('🔗 Trying common panorama naming patterns');
                    
                    const commonPatterns = [
                        `${room.room_number}-1`,
                        `${room.room_number}-2`, 
                        `${room.room_number}`,
                        `room${room.room_number}`,
                        `flat${room.room_number}`,
                        `pano${room.room_number}`
                    ];
                    
                    for (const pattern of commonPatterns) {
                        try {
                            const currentUrl = iframe.src;
                            const baseUrl = currentUrl.split('?')[0];
                            const newUrl = `${baseUrl}?startmedia=${pattern}`;
                            
                            console.log('🔗 Trying common pattern URL:', newUrl);
                            iframe.src = newUrl;
                            
                            // Wait a bit to see if it works
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            break;
                        } catch (error) {
                            continue;
                        }
                    }
                    navigationSuccess = true; // Assume one of the patterns worked
                }
                
                currentPanorama = room;
                showStatus(`Navigating to ${room.name}...`, 'info');
                
                // Give it time to navigate and then show description
                setTimeout(async () => {
                    showStatus(`Navigation completed for ${room.name}`, 'success');
                    console.log('🏁 Navigation attempt completed for:', room.name);
                    
                    // Show room description and speak it
                    await captureAndAnalyzeView(room);
                }, 3000);
                
                return navigationSuccess;

            } catch (error) {
                console.error('❌ Navigation error:', error);
                showStatus(`Navigation to ${room.name} failed`, 'error');
                return false;
            }
        }

        // Capture and analyze current view
        async function captureAndAnalyzeView(pano) {
            try {
                // Use predefined description instead of AI analysis
                const description = pano.description || `Welcome to ${pano.name}! You're now viewing this location in 360 degrees.`;
                const spokenText = pano.spoken_description || `You are now in ${pano.name}.`;
                
                console.log('Showing description for:', pano.name);
                
                // Show text description
                showAIResponse(description, pano.name);
                
                // Speak the description
                setTimeout(() => {
                    speakText(spokenText);
                }, 500);
                
            } catch (error) {
                console.error('Error displaying description:', error);
                const fallbackResponse = `I've taken you to ${pano.name}. This appears to be a 360-degree panoramic view of the location.`;
                showAIResponse(fallbackResponse, pano.name);
                speakText(`You are now in ${pano.name}.`);
            }
        }

        // Capture 3DVista view
        async function capture3DVistaView() {
            try {
                const iframe = document.querySelector('iframe');
                if (!iframe) return null;

                // Try to access 3DVista's screenshot API
                if (iframe.contentWindow && typeof iframe.contentWindow.takeScreenshot === 'function') {
                    return await iframe.contentWindow.takeScreenshot();
                }

                // Alternative: Try to get canvas element
                const canvas = iframe.contentDocument.querySelector('canvas');
                if (canvas) {
                    return canvas.toDataURL('image/jpeg', 0.8);
                }

                return null;
            } catch (error) {
                console.error('3DVista capture error:', error);
                return null;
            }
        }

        // Capture canvas view
        async function captureCanvasView() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 600;

                // This is a simplified capture - in reality, you'd need to
                // interface with 3DVista's rendering engine
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.fillText('3DVista View Capture', 20, 50);

                return canvas.toDataURL('image/jpeg', 0.8);
            } catch (error) {
                console.error('Canvas capture error:', error);
                return null;
            }
        }

        // Analyze image with AI (DISABLED FOR TESTING)
        async function analyzeImageWithAI(imageData) {
            // DISABLED FOR TESTING - Return simple message
            return "🎯 Navigation successful! You're now viewing this panorama. The AI vision analysis is currently disabled for testing - we're focusing on navigation only.";
            
            /* AI VISION CODE DISABLED FOR TESTING
            try {
                // Using OpenAI GPT-4 Vision API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-vision-preview',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Describe what you see in this 360-degree panoramic view. Focus on the room layout, furniture, architectural features, lighting, and overall atmosphere. Be detailed and conversational.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    throw new Error('Vision API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                console.error('AI vision analysis error:', error);
                
                // Fallback to Hugging Face Vision API
                try {
                    const response = await fetch('https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large', {
                        headers: {
                            'Authorization': `Bearer ${CONFIG.HUGGINGFACE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify({
                            inputs: imageData
                        })
                    });

                    const result = await response.json();
                    return `I can see: ${result[0].generated_text}. This appears to be a 360-degree panoramic view of the interior space.`;
                } catch (hfError) {
                    console.error('Hugging Face API error:', hfError);
                    return 'I can see this is a 360-degree panoramic view, but I\'m having trouble analyzing the specific details right now.';
                }
            }
            */
        }

        // Get text-based AI response
        async function getTextBasedResponse(pano) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful tour guide assistant. The user has just been taken to a location in a 3D virtual tour. Provide a welcoming and informative response.'
                            },
                            {
                                role: 'user',
                                content: `I've just been taken to ${pano.name}. Please welcome me and describe what I might expect to see in this type of location.`
                            }
                        ],
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error('Text API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                console.error('Text AI response error:', error);
                return `Welcome to ${pano.name}! You're now viewing this location in 360 degrees. Look around to explore the space.`;
            }
        }

        // Process general command
        async function processGeneralCommand(transcript) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a virtual tour guide. Available locations are: ${CONFIG.TOUR_CONFIG.panoramas.map(p => p.name).join(', ')}. Help the user navigate or provide information about the tour.`
                            },
                            {
                                role: 'user',
                                content: transcript
                            }
                        ],
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error('General command API request failed');
                }

                const data = await response.json();
                showAIResponse(data.choices[0].message.content, 'AI Assistant');

            } catch (error) {
                console.error('General command error:', error);
                showAIResponse('I\'m here to help you navigate the tour. Try saying something like "Take me to the lobby" or "Show me flat 101".', 'AI Assistant');
            }
        }

        // Show AI response
        function showAIResponse(message, location) {
            document.getElementById('ai-message').textContent = message;
            document.getElementById('ai-vision').textContent = location ? `Current location: ${location}` : '';
            document.getElementById('ai-response').classList.add('visible');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideAIResponse();
            }, 10000);
        }

        // Hide AI response
        function hideAIResponse() {
            document.getElementById('ai-response').classList.remove('visible');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('nav-status');
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Text-to-Speech functionality with natural human voice
        function speakText(text) {
            if (!text) return;
            
            try {
                // Check if speech synthesis is available
                if (!('speechSynthesis' in window)) {
                    console.warn('Speech synthesis not supported');
                    return;
                }
                
                // Stop any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create new speech synthesis utterance
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Configure voice settings for natural speech
                utterance.rate = 0.85; // Slightly slower for natural conversation
                utterance.pitch = 1.0;  // Normal pitch
                utterance.volume = 0.9; // Clear volume
                
                // Show stop button when speaking
                utterance.onstart = function() {
                    const stopBtn = document.getElementById('stop-speaking-btn');
                    if (stopBtn) {
                        stopBtn.classList.add('visible');
                    }
                };
                
                // Hide stop button when finished
                utterance.onend = function() {
                    const stopBtn = document.getElementById('stop-speaking-btn');
                    if (stopBtn) {
                        stopBtn.classList.remove('visible');
                    }
                };
                
                // Wait for voices to load, then speak
                if (window.speechSynthesis.getVoices().length > 0) {
                    setNaturalVoiceAndSpeak(utterance);
                } else {
                    window.speechSynthesis.onvoiceschanged = function() {
                        setNaturalVoiceAndSpeak(utterance);
                    };
                }
                
                console.log('Speaking with natural voice:', text);
                
            } catch (error) {
                console.error('Text-to-speech error:', error);
                // Fallback: Just show the text if speech fails
                showStatus('TTS: ' + text, 'info');
            }
        }

        // Helper function to set natural human voice and speak
        function setNaturalVoiceAndSpeak(utterance) {
            try {
                const voices = window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
                
                // Priority order for natural-sounding voices
                const preferredVoices = [
                    // High quality female voices
                    'Google US English Female',
                    'Microsoft Aria Online (Natural) - English (United States)',
                    'Microsoft Zira - English (United States)',
                    'Samantha',
                    'Alex',
                    'Karen',
                    'Moira',
                    'Tessa',
                    
                    // High quality male voices
                    'Google US English Male',
                    'Microsoft Guy Online (Natural) - English (United States)',
                    'Microsoft David - English (United States)',
                    'Daniel',
                    'Tom',
                    
                    // Fallback natural voices
                    'Google UK English Female',
                    'Google UK English Male',
                    'Microsoft Hazel - English (Great Britain)',
                    'Microsoft George - English (Great Britain)'
                ];
                
                let selectedVoice = null;
                
                // Try to find the best available voice
                for (const voiceName of preferredVoices) {
                    selectedVoice = voices.find(voice => 
                        voice.name.includes(voiceName) || voice.name === voiceName
                    );
                    if (selectedVoice) {
                        console.log('Selected preferred voice:', selectedVoice.name);
                        break;
                    }
                }
                
                // If no preferred voice found, look for any good English voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => 
                        voice.lang.includes('en') && 
                        (voice.name.includes('Google') || 
                         voice.name.includes('Microsoft') || 
                         voice.name.includes('Natural') ||
                         voice.name.includes('Premium'))
                    );
                }
                
                // Final fallback - any English voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang.includes('en'));
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    console.log('Using voice:', selectedVoice.name, selectedVoice.lang);
                } else {
                    console.log('Using default system voice');
                }
                
                // Speak the text
                window.speechSynthesis.speak(utterance);
                
            } catch (error) {
                console.error('Voice setting error:', error);
                // Still try to speak without voice preference
                window.speechSynthesis.speak(utterance);
            }
        }

        // Stop speech function
        function stopSpeaking() {
            try {
                window.speechSynthesis.cancel();
                const stopBtn = document.getElementById('stop-speaking-btn');
                if (stopBtn) {
                    stopBtn.classList.remove('visible');
                }
                console.log('Speech stopped');
            } catch (error) {
                console.error('Error stopping speech:', error);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing Voice AI Navigator');
            
            // Check if speech recognition is supported
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('Speech recognition not supported');
                showStatus('Speech recognition not supported. Please use Chrome or Edge browser.', 'error');
                document.getElementById('voice-btn').disabled = true;
                document.getElementById('voice-text').textContent = 'Speech not supported';
                document.getElementById('voice-subtitle').textContent = 'Use Chrome or Edge browser';
                return;
            }
            
            // Check if we're on HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                console.error('HTTPS required for voice recognition');
                showStatus('HTTPS required for voice recognition', 'error');
                document.getElementById('voice-btn').disabled = true;
                document.getElementById('voice-text').textContent = 'HTTPS required';
                return;
            }
            
            // Check API keys (DISABLED FOR TESTING)
            console.warn('API functionality disabled for testing - focusing on navigation only');
            showStatus('Navigation testing mode - API features disabled', 'info');
            
            // Add debugging for 3DVista tour
            setTimeout(() => {
                console.log('=== 3DVista Tour Debug Info ===');
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    console.log('Iframe found:', iframe.src);
                    
                    // Try to access iframe content (may fail due to CORS)
                    try {
                        if (iframe.contentWindow) {
                            console.log('Iframe content window accessible');
                            console.log('Available functions in iframe:', Object.keys(iframe.contentWindow));
                        }
                    } catch (e) {
                        console.log('Cannot access iframe content (CORS protected)');
                    }
                } else {
                    console.log('No iframe found!');
                }
                console.log('=== End Debug Info ===');
            }, 3000);
            
            // Add click event listener to voice button
            document.getElementById('voice-btn').addEventListener('click', function() {
                console.log('Voice button clicked');
                toggleVoiceRecognition();
            });
            
            console.log('Voice AI Navigator initialized successfully');
            showStatus('Voice AI Navigator ready - Click microphone to speak', 'success');
            
            // Play welcome message after everything is loaded
            setTimeout(() => {
                const welcomeText = "Welcome to our virtual tour! I'm your AI guide. You can ask me to take you to different apartments like flat 101, 106, or 105. Click the microphone and speak your command.";
                showAIResponse(welcomeText, 'AI Tour Guide');
                setTimeout(() => {
                    speakText(welcomeText);
                }, 1000);
            }, 2000);
        });

        // Listen for messages from 3DVista
        window.addEventListener('message', function(event) {
            if (event.data.type === '3dvista-node-changed') {
                const nodeId = event.data.nodeId;
                const pano = CONFIG.TOUR_CONFIG.panoramas.find(p => p.vista_node === nodeId);
                if (pano) {
                    currentPanorama = pano;
                    showStatus(`Now viewing: ${pano.name}`, 'info');
                }
            } else if (event.data.type === '3dvista-media-changed') {
                const mediaName = event.data.mediaName;
                const pano = CONFIG.TOUR_CONFIG.panoramas.find(p => p.media_name === mediaName);
                if (pano) {
                    currentPanorama = pano;
                    showStatus(`Now viewing: ${pano.name}`, 'info');
                }
            }
        });

        // Process general command
        async function processGeneralCommand(transcript) {
            try {
                const response = await getAIResponse(transcript);
                showAIResponse(response, 'AI Assistant');
            } catch (error) {
                console.error('General command error:', error);
                showAIResponse('I\'m here to help you navigate the tour. Try saying something like "Take me to flat 101" or "Show me apartment 106".', 'AI Assistant');
            }
        }

        // Additional navigation functions for different 3DVista URL methods
        function navigateByMediaName(mediaName) {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                const baseUrl = iframe.src.split('?')[0];
                const newUrl = `${baseUrl}?startmedia=${mediaName}`;
                console.log('Direct navigation to:', newUrl);
                iframe.src = newUrl;
            }
        }

        function navigateByNodeId(nodeId) {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                const baseUrl = iframe.src.split('?')[0];
                const newUrl = `${baseUrl}?startnode=${nodeId}`;
                console.log('Node navigation to:', newUrl);
                iframe.src = newUrl;
            }
        }
    </script>
</body>
</html>
