<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI Navigator - 3DVista Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }

        #main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 3DVista Tour Container */
        #tour-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Voice AI Control Panel */
        #voice-control {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        #voice-control:hover {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }

        #voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #voice-btn:hover {
            transform: scale(1.1);
        }

        #voice-btn.listening {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            animation: pulse 2s infinite;
        }

        #voice-btn.processing {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 210, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #voice-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        #voice-text {
            font-size: 16px;
            font-weight: 500;
            min-width: 200px;
            text-align: center;
        }

        #voice-subtitle {
            font-size: 12px;
            opacity: 0.7;
            text-align: center;
        }

        /* AI Response Panel */
        #ai-response {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        #ai-response.visible {
            transform: translateX(0);
        }

        #ai-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #ai-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        #ai-message {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        #ai-vision {
            font-size: 12px;
            opacity: 0.8;
            font-style: italic;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
            margin-top: 10px;
        }

        #close-response {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        #close-response:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation Status */
        #nav-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 999;
            display: none;
            transition: all 0.3s ease;
        }

        .status-success {
            background: rgba(0, 255, 0, 0.8) !important;
        }

        .status-error {
            background: rgba(255, 0, 0, 0.8) !important;
        }

        .status-info {
            background: rgba(0, 150, 255, 0.8) !important;
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #voice-control {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
                width: calc(100% - 20px);
            }

            #ai-response {
                right: 10px;
                top: 10px;
                width: calc(100% - 20px);
                transform: translateY(-450px);
            }

            #ai-response.visible {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <!-- 3DVista Tour will be embedded here -->
        <div id="tour-container">
            <!-- Replace this with your 3DVista embed code -->
            <iframe src="./index.html" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
        </div>

        <!-- Voice Control Panel -->
        <div id="voice-control">
            <button id="voice-btn" onclick="toggleVoiceRecognition()">üé§</button>
            <div id="voice-status">
                <div id="voice-text">Click to speak</div>
                <div id="voice-subtitle">Say "Take me to..." or "Show me..."</div>
            </div>
        </div>

        <!-- AI Response Panel -->
        <div id="ai-response">
            <div id="ai-header">
                <h3>ü§ñ AI Vision</h3>
                <button id="close-response" onclick="hideAIResponse()">√ó</button>
            </div>
            <div id="ai-content">
                <div id="ai-message"></div>
                <div id="ai-vision"></div>
            </div>
        </div>

        <!-- Navigation Status -->
        <div id="nav-status">Ready</div>

        <!-- Loading Overlay -->
        <div id="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Replace with your actual API keys
            OPENAI_API_KEY: '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',
            HUGGINGFACE_API_KEY: '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',
            
            // 3DVista Tour Configuration
            TOUR_CONFIG: {
                // Define your panoramas with 3DVista media names
                panoramas: [
                    {
                        id: 'flat_101',
                        name: 'Flat 101',
                        keywords: ['flat 101', 'apartment 101', 'unit 101', 'one zero one', '101'],
                        media_name: '101-1', // ‚Üê Your actual media name from 3DVista
                        vista_node: 'node1' // Optional: fallback node ID
                    },
                    {
                        id: 'flat_106',
                        name: 'Flat 106',
                        keywords: ['flat 106', 'apartment 106', 'unit 106', 'one zero six', '106'],
                        media_name: '106-1',
                        vista_node: 'node2'
                    },
                    {
                        id: 'flat_105',
                        name: 'Flat 105',
                        keywords: ['flat 105', 'apartment 105', 'unit 105', 'one zero five', '105'],
                        media_name: '105-1',
                        vista_node: 'node3'
                    }
                ]
            }
        };

        // Global variables
        let isListening = false;
        let isProcessing = false;
        let recognition = null;
        let currentPanorama = null;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                showStatus('Speech recognition not supported in this browser', 'error');
                return false;
            }

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                updateVoiceButton();
                updateVoiceStatus('Listening...', 'Speak your command');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Voice input:', transcript);
                updateVoiceStatus('Processing...', transcript);
                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                showStatus('Voice recognition error: ' + event.error, 'error');
                resetVoiceButton();
            };

            recognition.onend = function() {
                isListening = false;
                if (!isProcessing) {
                    resetVoiceButton();
                }
            };

            return true;
        }

        // Toggle voice recognition
        function toggleVoiceRecognition() {
            if (isListening || isProcessing) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        }

        // Start voice recognition
        function startVoiceRecognition() {
            if (!recognition) {
                if (!initSpeechRecognition()) return;
            }

            try {
                recognition.start();
            } catch (error) {
                console.error('Failed to start recognition:', error);
                showStatus('Failed to start voice recognition', 'error');
            }
        }

        // Stop voice recognition
        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
            }
            resetVoiceButton();
        }

        // Update voice button state
        function updateVoiceButton() {
            const btn = document.getElementById('voice-btn');
            if (isListening) {
                btn.classList.add('listening');
                btn.classList.remove('processing');
                btn.innerHTML = 'üéôÔ∏è';
            } else if (isProcessing) {
                btn.classList.add('processing');
                btn.classList.remove('listening');
                btn.innerHTML = 'ü§ñ';
            } else {
                btn.classList.remove('listening', 'processing');
                btn.innerHTML = 'üé§';
            }
        }

        // Reset voice button
        function resetVoiceButton() {
            isListening = false;
            isProcessing = false;
            updateVoiceButton();
            updateVoiceStatus('Click to speak', 'Say "Take me to..." or "Show me..."');
        }

        // Update voice status text
        function updateVoiceStatus(main, sub) {
            document.getElementById('voice-text').textContent = main;
            document.getElementById('voice-subtitle').textContent = sub;
        }

        // Process voice command
        async function processVoiceCommand(transcript) {
            isProcessing = true;
            updateVoiceButton();
            showLoading(true);

            try {
                // Find matching panorama
                const matchedPano = findMatchingPanorama(transcript);
                
                if (matchedPano) {
                    // Navigate to panorama
                    await navigateToVistaPanorama(matchedPano);
                    
                    // Wait a moment for navigation to complete
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Capture and analyze current view
                    await captureAndAnalyzeView(matchedPano);
                } else {
                    // Use AI to understand the command
                    await processGeneralCommand(transcript);
                }
            } catch (error) {
                console.error('Error processing voice command:', error);
                showStatus('Error processing command', 'error');
            } finally {
                showLoading(false);
                resetVoiceButton();
            }
        }

        // Find matching panorama
        function findMatchingPanorama(transcript) {
            const input = transcript.toLowerCase();
            return CONFIG.TOUR_CONFIG.panoramas.find(pano => 
                pano.keywords.some(keyword => 
                    input.includes(keyword.toLowerCase())
                )
            );
        }

        // Navigate to 3DVista panorama using URL parameters
        async function navigateToVistaPanorama(pano) {
            try {
                const iframe = document.querySelector('iframe');
                if (!iframe) {
                    throw new Error('Tour iframe not found');
                }

                // Method 1: Use 3DVista URL parameters to navigate by media name
                const baseUrl = iframe.src.split('?')[0]; // Get base URL without parameters
                const newUrl = `${baseUrl}?startmedia=${encodeURIComponent(pano.media_name)}`;
                
                // Update iframe source to navigate
                iframe.src = newUrl;
                currentPanorama = pano;
                showStatus(`Navigating to ${pano.name}...`, 'info');
                
                // Wait for navigation to complete
                await new Promise(resolve => {
                    const checkLoaded = () => {
                        try {
                            if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                                showStatus(`Navigated to ${pano.name}`, 'success');
                                resolve();
                            } else {
                                setTimeout(checkLoaded, 500);
                            }
                        } catch (e) {
                            // Cross-origin - assume loaded after delay
                            setTimeout(() => {
                                showStatus(`Navigated to ${pano.name}`, 'success');
                                resolve();
                            }, 2000);
                        }
                    };
                    checkLoaded();
                });
                
                return;

                // Method 2: Try direct API calls as fallback
                if (typeof gotoNode !== 'undefined') {
                    gotoNode(pano.vista_node || pano.media_name);
                    currentPanorama = pano;
                    showStatus(`Navigated to ${pano.name}`, 'success');
                    return;
                }

                // Method 3: PostMessage to 3DVista iframe
                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: '3dvista-navigate',
                        mediaName: pano.media_name,
                        nodeId: pano.vista_node
                    }, '*');
                    currentPanorama = pano;
                    showStatus(`Navigated to ${pano.name}`, 'success');
                    return;
                }

                // Method 4: JavaScript execution in iframe context
                if (iframe.contentDocument) {
                    const script = iframe.contentDocument.createElement('script');
                    script.textContent = `
                        if (typeof gotoMedia !== 'undefined') {
                            gotoMedia('${pano.media_name}');
                        } else if (typeof gotoNode !== 'undefined') {
                            gotoNode('${pano.vista_node || pano.media_name}');
                        } else if (typeof player !== 'undefined') {
                            if (player.gotoMedia) {
                                player.gotoMedia('${pano.media_name}');
                            } else if (player.gotoNode) {
                                player.gotoNode('${pano.vista_node || pano.media_name}');
                            }
                        }
                    `;
                    iframe.contentDocument.head.appendChild(script);
                    currentPanorama = pano;
                    showStatus(`Navigated to ${pano.name}`, 'success');
                    return;
                }
                
            } catch (error) {
                console.error('Navigation error:', error);
                showStatus('Navigation failed - check 3DVista integration', 'error');
            }
        }

        // Capture and analyze current view
        async function captureAndAnalyzeView(pano) {
            try {
                // Method 1: Try to get screenshot from 3DVista
                let imageData = await capture3DVistaView();
                
                // Method 2: If direct capture fails, use canvas screenshot
                if (!imageData) {
                    imageData = await captureCanvasView();
                }

                if (imageData) {
                    // Analyze with AI vision
                    const analysis = await analyzeImageWithAI(imageData);
                    showAIResponse(analysis, pano.name);
                } else {
                    // Fallback: Use text-based AI response
                    const response = await getTextBasedResponse(pano);
                    showAIResponse(response, pano.name);
                }
            } catch (error) {
                console.error('Error capturing/analyzing view:', error);
                const fallbackResponse = `I've taken you to ${pano.name}. This appears to be a 360-degree panoramic view of the location.`;
                showAIResponse(fallbackResponse, pano.name);
            }
        }

        // Capture 3DVista view
        async function capture3DVistaView() {
            try {
                const iframe = document.querySelector('iframe');
                if (!iframe) return null;

                // Try to access 3DVista's screenshot API
                if (iframe.contentWindow && typeof iframe.contentWindow.takeScreenshot === 'function') {
                    return await iframe.contentWindow.takeScreenshot();
                }

                // Alternative: Try to get canvas element
                const canvas = iframe.contentDocument.querySelector('canvas');
                if (canvas) {
                    return canvas.toDataURL('image/jpeg', 0.8);
                }

                return null;
            } catch (error) {
                console.error('3DVista capture error:', error);
                return null;
            }
        }

        // Capture canvas view
        async function captureCanvasView() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 600;

                // This is a simplified capture - in reality, you'd need to
                // interface with 3DVista's rendering engine
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.fillText('3DVista View Capture', 20, 50);

                return canvas.toDataURL('image/jpeg', 0.8);
            } catch (error) {
                console.error('Canvas capture error:', error);
                return null;
            }
        }

        // Analyze image with AI
        async function analyzeImageWithAI(imageData) {
            try {
                // Using OpenAI GPT-4 Vision API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-vision-preview',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Describe what you see in this 360-degree panoramic view. Focus on the room layout, furniture, architectural features, lighting, and overall atmosphere. Be detailed and conversational.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    throw new Error('Vision API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                console.error('AI vision analysis error:', error);
                
                // Fallback to Hugging Face Vision API
                try {
                    const response = await fetch('https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large', {
                        headers: {
                            'Authorization': `Bearer ${CONFIG.HUGGINGFACE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify({
                            inputs: imageData
                        })
                    });

                    const result = await response.json();
                    return `I can see: ${result[0].generated_text}. This appears to be a 360-degree panoramic view of the interior space.`;
                } catch (hfError) {
                    console.error('Hugging Face API error:', hfError);
                    return 'I can see this is a 360-degree panoramic view, but I\'m having trouble analyzing the specific details right now.';
                }
            }
        }

        // Get text-based AI response
        async function getTextBasedResponse(pano) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful tour guide assistant. The user has just been taken to a location in a 3D virtual tour. Provide a welcoming and informative response.'
                            },
                            {
                                role: 'user',
                                content: `I've just been taken to ${pano.name}. Please welcome me and describe what I might expect to see in this type of location.`
                            }
                        ],
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error('Text API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                console.error('Text AI response error:', error);
                return `Welcome to ${pano.name}! You're now viewing this location in 360 degrees. Look around to explore the space.`;
            }
        }

        // Process general command
        async function processGeneralCommand(transcript) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a virtual tour guide. Available locations are: ${CONFIG.TOUR_CONFIG.panoramas.map(p => p.name).join(', ')}. Help the user navigate or provide information about the tour.`
                            },
                            {
                                role: 'user',
                                content: transcript
                            }
                        ],
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error('General command API request failed');
                }

                const data = await response.json();
                showAIResponse(data.choices[0].message.content, 'AI Assistant');

            } catch (error) {
                console.error('General command error:', error);
                showAIResponse('I\'m here to help you navigate the tour. Try saying something like "Take me to the lobby" or "Show me flat 101".', 'AI Assistant');
            }
        }

        // Show AI response
        function showAIResponse(message, location) {
            document.getElementById('ai-message').textContent = message;
            document.getElementById('ai-vision').textContent = location ? `Current location: ${location}` : '';
            document.getElementById('ai-response').classList.add('visible');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideAIResponse();
            }, 10000);
        }

        // Hide AI response
        function hideAIResponse() {
            document.getElementById('ai-response').classList.remove('visible');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('nav-status');
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Voice AI Navigator initialized');
            
            // Check if speech recognition is supported
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus('Speech recognition not supported in this browser', 'error');
                document.getElementById('voice-btn').disabled = true;
            }
            
            // Check API keys
            if (CONFIG.OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                showStatus('Please configure your API keys', 'error');
            }
            
            showStatus('Voice AI Navigator ready', 'success');
        });

        // Listen for messages from 3DVista
        window.addEventListener('message', function(event) {
            if (event.data.type === '3dvista-node-changed') {
                const nodeId = event.data.nodeId;
                const pano = CONFIG.TOUR_CONFIG.panoramas.find(p => p.vista_node === nodeId);
                if (pano) {
                    currentPanorama = pano;
                    showStatus(`Now viewing: ${pano.name}`, 'info');
                }
            } else if (event.data.type === '3dvista-media-changed') {
                const mediaName = event.data.mediaName;
                const pano = CONFIG.TOUR_CONFIG.panoramas.find(p => p.media_name === mediaName);
                if (pano) {
                    currentPanorama = pano;
                    showStatus(`Now viewing: ${pano.name}`, 'info');
                }
            }
        });

        // Additional navigation functions for different 3DVista URL methods
        function navigateByMediaName(mediaName) {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                const baseUrl = iframe.src.split('?')[0];
                iframe.src = `${baseUrl}?startmedia=${encodeURIComponent(mediaName)}`;
            }
        }

        function navigateByNodeId(nodeId) {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                const baseUrl = iframe.src.split('?')[0];
                iframe.src = `${baseUrl}?startnode=${encodeURIComponent(nodeId)}`;
            }
        }

        function navigateByViewpoint(mediaName, viewpoint) {
            const iframe = document.querySelector('iframe');
            if (iframe) {
                const baseUrl = iframe.src.split('?')[0];
                <iframe src="./index.html" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
            }
        }
    </script>
</body>
</html>
